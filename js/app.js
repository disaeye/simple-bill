const AppModule=function(){let e=null,t=!1;async function n(){try{const e=["expenses.json"],t=[];for(const n of e)try{const e=await fetch("data/"+n);if(e.ok){const o=await e.json();o.expenses&&Array.isArray(o.expenses)&&o.expenses.length>0&&t.push(new File([JSON.stringify(o)],n,{type:"application/json"}))}}catch(e){}if(t.length>0){await DataModule.loadFromFiles(t);const e=DataModule.getExpenses();DataModule.mergeUnknownCategories(e),UIModule.showToast(I18nModule.t("msg.loaded",{count:t.length}))}}catch(e){console.log("从 data 目录加载数据失败:",e)}}function o(e){const t=document.getElementById("billingDaySection");t&&(t.style.display="month"===e?"":"none")}function d(){const e=FilterModule.getState(),t=DataModule.getExpenses(),n=UIModule.getTableFilters();FilterModule.setTableFilters(n);const o=FilterModule.applyFilters(t,DataModule),d=DataModule.calculateStats(o),l=e.category?t.filter(function(t){return t.category1===e.category}):t,i=DataModule.calculateMoMStats(l,e.dimension,e.periodValue,e.billingDay);UIModule.updateStats(d,i),a(e.dimension);const s=FilterModule.getTrendData(t,DataModule);ChartModule.updateTrendChart(s,e.dimension,e.periodValue),ChartModule.updateCategoryChart(o),UIModule.renderExpenseList(o)}function a(e){const t=document.getElementById("trendChartTitle");if(!t)return;const n={year:I18nModule.t("chart.trendYear"),quarter:I18nModule.t("chart.trendQuarter"),week:I18nModule.t("chart.trendWeek"),month:I18nModule.t("chart.trend"),all:I18nModule.t("chart.trendAll")};t.textContent=n[e]||I18nModule.t("chart.trend")}return{init:async function(){I18nModule.init(),UIModule.init(),UIModule.renderBillingDayOptions(),"undefined"==typeof echarts&&await new Promise(e=>{const t=setInterval(()=>{"undefined"!=typeof echarts&&(clearInterval(t),e())},100)}),ChartModule.initCharts(),await DataModule.loadCategoriesFromFile(),document.getElementById("langToggleBtn").addEventListener("click",function(){I18nModule.toggleLang()}),document.addEventListener("languageChange",function(e){a(FilterModule.getState().dimension)}),document.addEventListener("filterChange",function(){d()}),document.addEventListener("saveExpense",function(e){const n=e.detail;n.id?(DataModule.updateExpense(n.id,n),UIModule.showToast(I18nModule.t("msg.updateSuccess"))):(DataModule.addExpense(n),UIModule.showToast(I18nModule.t("msg.saveSuccess"))),UIModule.closeModal(),d(),t&&UIModule.showToast(I18nModule.t("msg.localModeHint"))}),document.addEventListener("editExpense",function(e){UIModule.openModal("edit",e.detail)}),document.addEventListener("deleteExpense",function(e){const n=e.detail;DataModule.deleteExpense(n)&&(UIModule.showToast(I18nModule.t("msg.deleteSuccess")),d(),t&&UIModule.showToast(I18nModule.t("msg.localModeHint")))}),document.getElementById("exportBtn").addEventListener("click",function(){const e={expenses:DataModule.getExpenses()},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download="expenses_"+(new Date).toISOString().split("T")[0]+".json",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),UIModule.showToast(I18nModule.t("msg.exportSuccess"))}),document.getElementById("importBtn").addEventListener("click",function(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async function(e){const t=e.target.files[0];if(t)try{const e=await t.text(),n=JSON.parse(e);if(!n.expenses||!Array.isArray(n.expenses))return void UIModule.showToast(I18nModule.t("msg.formatError"));const o=DataModule.getExpenses(),a=new Set(o.map(function(e){return e.id}));let l=0;for(const e of n.expenses)a.has(e.id)||(o.push(e),l++);o.sort(function(e,t){return new Date(t.date)-new Date(e.date)}),DataModule.loadFromFiles([new File([JSON.stringify({expenses:o})],"merged.json",{type:"application/json"})]);const i=DataModule.getCategory1List();UIModule.renderCategoryFilter(i),d(),UIModule.showToast(I18nModule.t("msg.importSuccess",{count:l}))}catch(e){UIModule.showToast(I18nModule.t("msg.jsonError"))}},e.click()}),document.getElementById("selectDataBtn").addEventListener("click",function(){document.getElementById("directoryInput").click()}),document.getElementById("directoryInput").addEventListener("change",async function(n){const o=Array.from(n.target.files).filter(function(e){return e.name.endsWith(".json")});if(o.length>0){t=!0,e=o[0].webkitRelativePath.split("/")[0],await DataModule.loadFromFiles(o);const n=DataModule.getCategory1List();UIModule.renderCategoryFilter(n),d(),UIModule.showToast("已加载 "+o.length+" 个数据文件（本地模式）")}}),document.getElementById("refreshBtn").addEventListener("click",async function(){t&&e?document.getElementById("directoryInput").click():await n(),UIModule.showToast(I18nModule.t("msg.refreshed"))}),function(){const e=document.getElementById("billingDay");e.innerHTML="";for(let t=1;t<=28;t++){const n=document.createElement("option");n.value=t,n.textContent=t+("zh"===I18nModule.getLang()?" 日":"th"),e.appendChild(n)}}(),document.getElementById("dimension").addEventListener("change",function(){FilterModule.setDimension(this.value),UIModule.updatePeriodOptions(this.value),o(this.value)}),document.getElementById("billingDay").addEventListener("change",function(){FilterModule.setBillingDay(this.value)}),document.getElementById("periodSelect").addEventListener("change",function(){FilterModule.setPeriodValue(this.value)}),o(document.getElementById("dimension").value),FilterModule.initFromUI({dimension:document.getElementById("dimension"),billingDay:document.getElementById("billingDay"),periodSelect:document.getElementById("periodSelect"),categoryFilter:document.getElementById("categoryFilter")}),await n();const l=DataModule.getCategory1List();UIModule.renderCategoryFilter(l);const i=FilterModule.getState();UIModule.updatePeriodOptions(i.dimension),d()},refreshDisplay:d,syncFromChartDrillDown:function(e){FilterModule.syncCategoryFromDrillDown(e)}}}();document.addEventListener("DOMContentLoaded",function(){AppModule.init()});