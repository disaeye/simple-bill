const AppModule=function(){let e=null,t=!1;async function n(){try{const e=["expenses.json"],t=[];for(const n of e)try{const e=await fetch(`data/${n}`);if(e.ok){const o=await e.json();o.expenses&&Array.isArray(o.expenses)&&o.expenses.length>0&&t.push(new File([JSON.stringify(o)],n,{type:"application/json"}))}}catch(e){}if(t.length>0){await DataModule.loadFromFiles(t);const e=DataModule.getExpenses();DataModule.mergeUnknownCategories(e),UIModule.showToast(`已加载 ${t.length} 个数据文件`)}}catch(e){console.log("从 data 目录加载数据失败:",e)}}function o(e){const t=document.getElementById("billingDaySection");t&&(t.style.display="month"===e?"":"none")}function a(){const e=FilterModule.getState(),t=DataModule.getExpenses(),n=UIModule.getTableFilters();FilterModule.setTableFilters(n);const o=FilterModule.applyFilters(t,DataModule),a=DataModule.calculateStats(o),d=e.category?t.filter(t=>t.category1===e.category):t,l=DataModule.calculateMoMStats(d,e.dimension,e.periodValue,e.billingDay);UIModule.updateStats(a,l),function(e){const t=document.getElementById("trendChartTitle");if(!t)return;const n={year:"年度支出趋势",quarter:"季度支出趋势",week:"周支出趋势",month:"月度支出趋势",all:"全部支出趋势"};t.textContent=n[e]||"月度支出趋势"}(e.dimension);const i=FilterModule.getTrendData(t,DataModule);ChartModule.updateTrendChart(i,e.dimension,e.periodValue),ChartModule.updateCategoryChart(o),UIModule.renderExpenseList(o)}return{init:async function(){UIModule.init(),ChartModule.initCharts(),await DataModule.loadCategoriesFromFile(),document.addEventListener("filterChange",()=>{a()}),document.addEventListener("saveExpense",e=>{const n=e.detail;n.id?(DataModule.updateExpense(n.id,n),UIModule.showToast("更新成功")):(DataModule.addExpense(n),UIModule.showToast("添加成功")),UIModule.closeModal(),a(),t&&UIModule.showToast('数据已更新，请点击"导出数据"保存到本地')}),document.addEventListener("editExpense",e=>{UIModule.openModal("edit",e.detail)}),document.addEventListener("deleteExpense",e=>{const n=e.detail;DataModule.deleteExpense(n)&&(UIModule.showToast("删除成功"),a(),t&&UIModule.showToast('数据已更新，请点击"导出数据"保存到本地'))}),document.getElementById("exportBtn").addEventListener("click",()=>{const e={expenses:DataModule.getExpenses()},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n;const a=(new Date).toISOString().split("T")[0];o.download=`expenses_${a}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),UIModule.showToast("数据已导出")}),document.getElementById("importBtn").addEventListener("click",()=>{const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async e=>{const t=e.target.files[0];if(t)try{const e=await t.text(),n=JSON.parse(e);if(!n.expenses||!Array.isArray(n.expenses))return void UIModule.showToast("数据格式错误");const o=DataModule.getExpenses(),d=new Set(o.map(e=>e.id));let l=0;for(const e of n.expenses)d.has(e.id)||(o.push(e),l++);o.sort((e,t)=>new Date(t.date)-new Date(e.date)),DataModule.loadFromFiles([new File([JSON.stringify({expenses:o})],"merged.json",{type:"application/json"})]);const i=DataModule.getCategory1List();UIModule.renderCategoryFilter(i),a(),UIModule.showToast(`成功导入 ${l} 条记录`)}catch(e){UIModule.showToast("JSON 格式错误")}},e.click()}),document.getElementById("selectDataBtn").addEventListener("click",()=>{document.getElementById("directoryInput").click()}),document.getElementById("directoryInput").addEventListener("change",async n=>{const o=Array.from(n.target.files).filter(e=>e.name.endsWith(".json"));if(o.length>0){t=!0,e=o[0].webkitRelativePath.split("/")[0],await DataModule.loadFromFiles(o);const n=DataModule.getCategory1List();UIModule.renderCategoryFilter(n),a(),UIModule.showToast(`已加载 ${o.length} 个数据文件（本地模式）`)}}),document.getElementById("refreshBtn").addEventListener("click",async()=>{t&&e?document.getElementById("directoryInput").click():await n(),UIModule.showToast("已刷新")}),FilterModule.initFromUI({dimension:document.getElementById("dimension"),billingDay:document.getElementById("billingDay"),periodSelect:document.getElementById("periodSelect"),categoryFilter:document.getElementById("categoryFilter")}),function(){const e=document.getElementById("billingDay");e.innerHTML="";for(let t=1;t<=28;t++){const n=document.createElement("option");n.value=t,n.textContent=t+" 日",e.appendChild(n)}}(),document.getElementById("dimension").addEventListener("change",function(){FilterModule.setDimension(this.value),UIModule.updatePeriodOptions(this.value),o(this.value)}),document.getElementById("billingDay").addEventListener("change",function(){FilterModule.setBillingDay(this.value)}),document.getElementById("periodSelect").addEventListener("change",function(){FilterModule.setPeriodValue(this.value)}),o(document.getElementById("dimension").value),await n();const d=DataModule.getCategory1List();UIModule.renderCategoryFilter(d);const l=FilterModule.getState();UIModule.updatePeriodOptions(l.dimension),a()},refreshDisplay:a,syncFromChartDrillDown:function(e){FilterModule.syncCategoryFromDrillDown(e)}}}();document.addEventListener("DOMContentLoaded",()=>{AppModule.init()});