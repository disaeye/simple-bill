const ChartModule=function(){let e=null,t=null,o={level:0,firstLevelStats:null,filteredExpenses:[]};function n(){o.level=0,o.selectedCategory=null;const e=document.getElementById("categoryBackBtn");e&&e.classList.add("hidden"),a(o.firstLevelStats,!1),"undefined"!=typeof FilterModule&&FilterModule.clearCategoryFilter()}function a(e,n){if(!t)return;const a=Object.entries(e).filter(([e,t])=>t>0).sort((e,t)=>t[1]-e[1]);let r;if(n){const e=o.selectedCategory?DataModule.getCategoryColor(o.selectedCategory):"#E17055";r=a.map((t,o)=>function(e,t){const o=parseInt(e.replace("#",""),16),n=Math.round(2.55*t),a=Math.min(255,Math.max(0,(o>>16)+n)),r=Math.min(255,Math.max(0,(o>>8&255)+n)),l=Math.min(255,Math.max(0,(255&o)+n));return"#"+(16777216+65536*a+256*r+l).toString(16).slice(1)}(e,15*o))}else r=a.map(([e])=>DataModule.getCategoryColor(e));const l=a.map(([e,t],o)=>({name:e,value:t,itemStyle:{color:r[o]}}));t.setOption({series:[{data:l,label:{show:!n}}]})}return{initCharts:function(){const r=document.getElementById("trendChart"),l=document.getElementById("categoryChart"),i=document.getElementById("categoryBackBtn");r&&(e=echarts.init(r),function(){const t={grid:{left:"3%",right:"4%",bottom:"3%",top:"15%",containLabel:!0},xAxis:{type:"category",data:[],axisLabel:{color:"#636E72",fontSize:11},axisLine:{lineStyle:{color:"#E0E0E0"}}},yAxis:{type:"value",axisLabel:{color:"#636E72",formatter:e=>"¥"+e.toLocaleString()},splitLine:{lineStyle:{color:"#F0F0F0"}}},tooltip:{trigger:"axis",formatter:e=>{const t=e[0].value;return`${e[0].name}<br/>支出: <strong>¥${t.toLocaleString()}</strong>`}},series:[{name:"支出",type:"bar",data:[],barWidth:"50%",itemStyle:{color:"#E17055",borderRadius:[4,4,0,0]},label:{show:!0,position:"top",formatter:e=>"¥"+e.value.toLocaleString(),color:"#636E72",fontSize:10}}]};e.setOption(t)}()),l&&(t=echarts.init(l),function(){const e={tooltip:{trigger:"item",formatter:e=>e.value?`${e.name}<br/>¥${e.value.toLocaleString()} (${e.percent}%)`:`${e.name}: ¥0 (0%)`},legend:{orient:"vertical",right:10,top:"center",textStyle:{color:"#636E72",fontSize:12},formatter:e=>e},series:[{name:"分类",type:"pie",radius:["45%","70%"],center:["40%","50%"],avoidLabelOverlap:!0,itemStyle:{borderRadius:4,borderColor:"#fff",borderWidth:2},label:{show:!0,position:"outside",formatter:"{b}: ¥{c}",color:"#636E72",fontSize:11},labelLine:{show:!0,lineStyle:{color:"#CCC"}},emphasis:{label:{show:!0,fontSize:12,fontWeight:"bold"},itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.3)"}},data:[]}]};t.setOption(e),t.on("click",function(e){0===o.level&&(!function(e){o.level=1,o.selectedCategory=e;const t=document.getElementById("categoryBackBtn");t&&t.classList.remove("hidden");a(function(e,t){const o={};return e.forEach(e=>{if("expense"===e.type&&e.category1===t){const t=e.category2||"未分类";o[t]||(o[t]=0),o[t]+=Math.abs(e.amount)}}),o}(o.filteredExpenses,e),!0)}(e.name),"undefined"!=typeof AppModule&&AppModule.syncFromChartDrillDown(e.name))})}()),i&&i.addEventListener("click",()=>{n()}),window.addEventListener("resize",()=>{e&&e.resize(),t&&t.resize()})},updateTrendChart:function(t,o,n){if(!e)return;const a=Object.keys(t).sort();if(0===a.length)return void e.setOption({xAxis:{data:[]},series:[{data:[]}]});let r=0;n&&"all"!==n?(r=a.indexOf(n),-1===r&&(r=a.findIndex(e=>e.localeCompare(n)>=0),-1===r&&(r=a.length-1))):a.length>0&&(r=a.length-1);const l=Math.max(0,r-4),i=Math.min(a.length-1,r+4),s=a.slice(l,i+1),c=s.map(e=>e.includes("-Q")?e.replace("-Q","年Q"):e.includes("-W")?e.replace("-W","年W"):e.includes("-")?e.replace("-","年")+"月":e+"年"),d=s.map(e=>t[e].expense);e.setOption({xAxis:{data:c},series:[{data:d}]})},updateCategoryChart:function(e){if(!t)return;o.filteredExpenses=e,o.level=0,o.selectedCategory=null;const n=function(e){const t={};return e.forEach(e=>{"expense"===e.type&&(t[e.category1]||(t[e.category1]=0),t[e.category1]+=Math.abs(e.amount))}),t}(e);o.firstLevelStats=n,a(n,!1)},clearCharts:function(){e&&e.setOption({xAxis:{data:[]},series:[{data:[]}]}),t&&t.setOption({series:[{data:[]}]}),o={level:0,firstLevelStats:null,selectedCategory:null,filteredExpenses:[]}},drillUpToCategory1:n}}();